<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solv.us Stage</title>

    <link rel="stylesheet" href="stage.css">
</head>

<body>
    <section class="screen-disabled no-signal center-content" >
        <div class="center-content">
            <div>
                <h1>stage #<span class="stageId"></span></h1>
                <h2><span class="screenSize"></span></h2>
                <span class="loaded">loaded: false</span>
                <span class="smpte">00:00:00:00</span><br>
                <span class="beat"></span><br>
                <span class="beat2"></span>
            </div>
        </div>
    </section>
    
    <video class="screen" id="screen" loop playsinline preload="auto">
        <source id="source" src="" type="video/mp4">
    </video>
    
    <script src="./js/requestInterval.js"></script>
    <script src="./js/socket.io.js"></script>
    <script src="./js/timesync.js"></script>
    <script src="./js/smpte.js"></script>
    <script src="./js/Clock.js"></script>
    <script src="./js/Client.js"></script>

    <script>

        // Get the Stage ?id= parameter from the url.
        let params = new URLSearchParams(document.location.search.substring(1));
        let stageId = params.get("id");

        // Connect to server
        let serverURI = window.location.host;
        const socket = io(serverURI + '/client');
        const timeSocket = io(serverURI + '/time');

        let client = new Client(socket, stageId);

        // Setup timesync
        let ts = timesync.create({
            server: timeSocket,
            interval: 50
        });

        ts.send = function (socket, data, timeout) {
            //console.log('send', data);
            return new Promise(function (resolve, reject) {
                var timeoutFn = setTimeout(reject, timeout);

                socket.emit('timesync', data, function () {
                    clearTimeout(timeoutFn);
                    resolve();
                });
            });
        };
        timeSocket.on('timesync', function (data) {
            ts.receive(null, data);
        });

    </script>
</body>
</html>